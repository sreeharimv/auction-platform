<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live Bidding - {{ player.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container" style="max-width: 1400px !important; margin: 20px auto 40px !important; padding: 0 20px !important;">
    <div class="header">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Palace Premier League" class="logo">
      <h1>Live Auction - {{ player.name }}</h1>
    </div>
    
    <nav style="margin-top: 20px;">
      <a href="{{ url_for('auction') }}">← Back to Auction</a>
      <a href="{{ url_for('live_view') }}" target="_blank">Public View</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Current Player -->
    <div class="grid" style="margin-bottom: 20px;">
      <div class="card" style="text-align: center; padding: 30px;">
        <div class="label" style="margin-bottom: 20px;">Current Player</div>
        <img src="{{ url_for('static', filename='players/' + (player.photo or 'default.png')) }}?t={{ timestamp() }}" alt="{{ player.name }}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #93c5fd; margin: 0 auto 20px; display: block; box-shadow: 0 8px 32px rgba(147, 197, 253, 0.3);" onerror="this.src='{{ url_for('static', filename='players/default.png') }}'">
        <div class="metric" style="font-size: 32px; margin-bottom: 8px;">{{ player.name }}</div>
        <div style="color: #94a3b8; font-size: 16px;">{{ player.role }}</div>
      </div>
      <div class="card">
        <div class="label">Base Price</div>
        <div id="lb-base" class="metric">₹{{ format_currency(player.base_price) }}</div>
      </div>
      <div class="card">
        <div class="label">Current Bid</div>
        <div id="lb-bid" class="metric" style="color: #10b981;">₹{{ format_currency(auction_state.current_bid) }}</div>
        <div id="lb-leader" style="color: #94a3b8;">{{ auction_state.current_team or "No bids yet" }}</div>
      </div>
      <div class="card">
        <div class="label">Status</div>
        <div id="lb-status" class="metric" style="font-size: 18px; text-transform: uppercase;">{{ auction_state.status }}</div>
      </div>
      {% if starting_team %}
      <div class="card">
        <div class="label">Starting Team</div>
        <div class="metric" style="font-size: 20px;">{{ starting_team }}</div>
      </div>
      {% endif %}
    </div>

    

    {% if auction_state.status == "waiting" %}
    <div class="card">
      <h3>Start Bidding</h3>
      <form method="post">
        <button class="btn" name="action" value="start_bidding" style="font-size: 18px; padding: 12px 24px;">
          Start Bidding at ₹{{ format_currency(player.base_price) }}
        </button>
      </form>
      {% if next_bid %}
      <div style="margin-top: 12px;">
        <div id="lb-next-wrap" class="label" style="margin-bottom: 6px;">Quick Bid (Next: ₹{{ format_currency(next_bid) }})</div>
        <div id="lb-team-buttons-start" style="display: flex; gap: 8px; flex-wrap: wrap;">
          {% for team in teams %}
            {% set tl = team_limits.get(team) %}
            <form method="post" style="display: inline;">
              <input type="hidden" name="team" value="{{ team }}">
              <input id="lb-next-start-{{ loop.index }}" type="hidden" name="bid_amount" value="{{ next_bid }}">
              <button data-team="{{ team }}" class="btn" name="action" value="update_bid" {% if not tl or not tl.can_bid_now %}disabled style="opacity:0.5; cursor:not-allowed;"{% endif %}>{{ team }}</button>
            </form>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if auction_state.status in ["bidding", "going"] %}
    <!-- Quick Bidding Controls -->
    <div class="card">
      <h3>Quick Bid</h3>
      {% if next_bid %}
        <div id="lb-next" class="label" style="margin-bottom: 6px;">Next Required Bid: ₹{{ format_currency(next_bid) }}</div>
        <div id="lb-team-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
          {% for team in teams %}
            {% set tl = team_limits.get(team) %}
            <button data-team="{{ team }}" class="btn lb-quick" {% if not tl or not tl.can_bid_now %}disabled style="opacity:0.5; cursor:not-allowed;"{% endif %}>{{ team }}</button>
          {% endfor %}
        </div>
      {% else %}
        <div style="color:#94a3b8;">No higher increments available.</div>
      {% endif %}

      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button id="lb-sold" class="btn" style="background: #10b981; font-size: 16px; padding: 12px 24px;">SOLD!</button>
        <button id="lb-undo" class="btn secondary" style="background:#64748b;">UNDO</button>
      </div>
    </div>
    {% endif %}

    <!-- Row 3: Teams who can bid now (admin view) -->
    {% if team_limits %}
      {% set eligible = team_limits.values()|selectattr('can_bid_now')|list %}
      <div id="lb-eligible-container" class="card" style="padding: 12px; margin-top:16px;">
        <h3 style="margin: 0 0 8px;">Teams Who Can Bid Now</h3>
        {% if eligible|length == 0 %}
          <div id="lb-eligible-empty" style="color: #94a3b8;">No teams can place the next bid.</div>
        {% else %}
        <div id="lb-eligible-grid" class="grid" style="margin-top: 8px;">
          {% for team, info in team_limits.items() %}
            {% if info.can_bid_now %}
            <div class="card" style="padding: 12px;">
              <div class="label">{{ team }}</div>
              <div class="metric" style="color: {{ '#f59e0b' if info.near_limit else '#10b981' }};">
                ₹{{ format_currency(info.max_valid_bid) }}
              </div>
              <div style="color: #94a3b8; font-size: 12px;">
                Remaining: ₹{{ format_currency(info.remaining) }} • Players: {{ info.players_with_captain }}/{{ CONFIG.teams.max_players }}
              </div>
              {% if info.near_limit %}
                <div style="color: #f59e0b; font-size: 12px; margin-top: 4px;">Only one increment possible</div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
    {% endif %}

  </div>
  <script>
    (function(){
      // Mirror live-view: update fields via SSE to keep next bid fresh
      const INCREMENTS = {{ CONFIG.auction.increments|tojson }};
      const BASE_PRICE = {{ player.base_price }};
      function formatCurrencyShort(amount){
        if (!amount) return '0';
        amount = parseInt(amount);
        if (amount >= 10000000) {
          const cr = (amount/10000000).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
          return cr + 'Cr';
        } else if (amount >= 100000) {
          const l = (amount/100000).toFixed(1).replace(/\.0$/, '');
          return l + 'L';
        }
        return amount.toLocaleString('en-IN');
      }
      function nextRequiredBid(current, base, hasLeader){
        current = parseInt(current||0); base = parseInt(base||0);
        if (!hasLeader) return Math.max(current, base);
        let step;
        if (current < base*2) step = INCREMENTS[0];
        else if (current < base*4) step = INCREMENTS[1];
        else step = INCREMENTS[2];
        return current + step;
      }
      function updateButtons(nextBid, eligibleTeams){
        // Update both start and ongoing button groups if present
        const groups = [document.getElementById('lb-team-buttons'), document.getElementById('lb-team-buttons-start')];
        groups.forEach((grp)=>{
          if (!grp) return;
          const forms = grp.querySelectorAll('form');
          forms.forEach((f, idx)=>{
            const btn = f.querySelector('button.btn');
            const hidden = f.querySelector('input[name="bid_amount"]');
            if (hidden) hidden.value = nextBid;
            const team = btn ? btn.getAttribute('data-team') : null;
            const enabled = team && eligibleTeams.includes(team);
            if (btn){
              btn.disabled = !enabled;
              btn.style.opacity = enabled ? '' : '0.5';
              btn.style.cursor = enabled ? '' : 'not-allowed';
            }
          });
        });
        const nextLabel = document.getElementById('lb-next');
        if (nextLabel) nextLabel.textContent = 'Next Required Bid: ₹' + formatCurrencyShort(nextBid);
        const nextWrap = document.getElementById('lb-next-wrap');
        if (nextWrap) nextWrap.textContent = 'Quick Bid (Next: ₹' + formatCurrencyShort(nextBid) + ')';
      }
      function connect(){
        try{
          const es = new EventSource('{{ url_for('events') }}');
          es.onmessage = function(evt){
            try{
              const data = JSON.parse(evt.data);
              if (!data || data.type !== 'state') return;
              const s = data.payload || {}; const a = s.auction || {};
              const player = s.player || {};
              // If switched player, reload this admin view to match
              const expectedId = {{ player.player_id }};
              if (player.id && player.id !== expectedId){ location.reload(); return; }
              // Patch fields
              const bidEl = document.getElementById('lb-bid');
              const leaderEl = document.getElementById('lb-leader');
              const statusEl = document.getElementById('lb-status');
              const eligibleGrid = document.getElementById('lb-eligible-grid');
              const eligibleEmpty = document.getElementById('lb-eligible-empty');
              const eligibleContainer = document.getElementById('lb-eligible-container');
              if (bidEl) bidEl.textContent = '₹' + formatCurrencyShort(a.current_bid || 0);
              if (leaderEl) leaderEl.textContent = a.current_team || 'No bids yet';
              if (statusEl) statusEl.textContent = (a.status || '').toUpperCase();
              // Compute next required and enable buttons only if bidding/going
              const st = (a.status||'').toLowerCase();
              if (st === 'bidding' || st === 'going'){
                const nextBid = nextRequiredBid(a.current_bid||0, player.base_price||BASE_PRICE, !!a.current_team);
                const elig = Array.isArray(s.eligible) ? s.eligible.map(e=>e.team) : [];
                updateButtons(nextBid, elig);
                // Rebuild eligible grid
                if (eligibleContainer) eligibleContainer.style.display = '';
                if (eligibleGrid || eligibleEmpty){
                  const list = Array.isArray(s.eligible) ? s.eligible : [];
                  if (list.length === 0){
                    if (eligibleGrid) eligibleGrid.innerHTML = '';
                    if (eligibleEmpty) eligibleEmpty.style.display = '';
                  } else {
                    if (eligibleEmpty) eligibleEmpty.style.display = 'none';
                    if (eligibleGrid){
                      eligibleGrid.innerHTML = list.map(item => `
                        <div class=\"card\" style=\"padding: 12px;\">\n\
                          <div class=\"label\">${item.team}</div>\n\
                          <div class=\"metric\" style=\"color: ${item.near_limit ? '#f59e0b' : '#10b981'};\">\n\
                            ₹${formatCurrencyShort(item.max_valid_bid || 0)}\n\
                          </div>\n\
                          <div style=\"color: #94a3b8; font-size: 12px;\">\n\
                            Remaining: ₹${formatCurrencyShort(item.remaining || 0)} • Players: ${item.players_with_captain}/{{ CONFIG.teams.max_players }}\n\
                          </div>\n\
                          ${item.near_limit ? '<div style=\"color: #f59e0b; font-size: 12px; margin-top: 4px;\">Only one increment possible</div>' : ''}\n\
                        </div>`).join('');
                    }
                  }
                }
              } else {
                updateButtons(a.current_bid||0, []);
                if (eligibleContainer) eligibleContainer.style.display = 'none';
              }
            }catch(e){ /* ignore */ }
          };
          es.onerror = function(){ try{es.close();}catch(e){} setTimeout(connect, 1000); };
        }catch(e){ setTimeout(connect, 1500); }
      }
      // Intercept quick-bid buttons to call fast API
      function bindActions(){
        const buttons = document.querySelectorAll('.lb-quick');
        buttons.forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (btn.disabled) return;
            btn.disabled = true; setTimeout(()=>{btn.disabled=false;}, 600);
            const team = btn.getAttribute('data-team');
            try{
              const resp = await fetch('{{ url_for('api_bid') }}', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ player_id: {{ player.player_id }}, team })
              });
              const data = await resp.json().catch(()=>({}));
              // Optimistic UI update for snappy feel
              const bidEl = document.getElementById('lb-bid');
              const leaderEl = document.getElementById('lb-leader');
              const statusEl = document.getElementById('lb-status');
              const applied = (data && (data.applied_bid || data.next_bid)) || 0;
              if (bidEl && applied) bidEl.textContent = '₹' + formatCurrencyShort(applied);
              if (leaderEl) leaderEl.textContent = team;
              if (statusEl) statusEl.textContent = 'BIDDING';
              const nr = (data && data.next_required) || nextRequiredBid(applied, BASE_PRICE, true);
              updateButtons(nr, []);
            }catch(e){}
          });
        });
        const soldBtn = document.getElementById('lb-sold');
        if (soldBtn){
          soldBtn.addEventListener('click', async (e)=>{
            e.preventDefault();
            soldBtn.disabled = true; setTimeout(()=>{soldBtn.disabled=false;}, 800);
            try{ 
              const resp = await fetch('{{ url_for('api_sold') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ player_id: {{ player.player_id }} }) });
              // Optimistic: reflect SOLD state immediately
              const statusEl = document.getElementById('lb-status');
              if (statusEl) statusEl.textContent = 'SOLD';
              updateButtons(0, []);
            }catch(e){}
          });
        }
        const undoBtn = document.getElementById('lb-undo');
        if (undoBtn){
          undoBtn.addEventListener('click', async (e)=>{
            e.preventDefault();
            undoBtn.disabled = true; setTimeout(()=>{undoBtn.disabled=false;}, 600);
            try{
              await fetch('{{ url_for('api_undo') }}', { method:'POST' });
            }catch(e){}
          });
        }
      }
      bindActions();
      connect();
    })();
  </script>
</body>
</html>
