<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live Auction View</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Removed meta refresh; we poll a lightweight version endpoint instead. -->
</head>
<body>
  <div id="lv-root" class="container" style="max-width: 1400px !important; margin: 20px auto 40px !important; padding: 0 20px !important;" data-player-id="{{ current_player.player_id if current_player else '' }}">
    <div class="header">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="{{ CONFIG.tournament.name }}" class="logo">
      <h1>{{ CONFIG.tournament.name }}</h1>
    </div>
    
    <nav style="margin-top: 20px;">
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('players') }}">Players</a>
      <a href="{{ url_for('teams') }}">Teams</a>
      <a href="{{ url_for('results') }}">Live Results</a>
      <a href="{{ url_for('admin') }}">Admin</a>
    </nav>

    

    {% if current_player %}
    <div class="grid" style="margin-bottom: 20px; grid-template-columns: 360px 1fr; gap: 20px; align-items: stretch;">
      <!-- Left column: Larger player photo -->
      <div class="card" style="text-align: center; padding: 30px;">
        <img id="lv-photo" src="{{ url_for('static', filename='players/' + (current_player.photo or 'default.png')) }}?t={{ timestamp() }}" alt="{{ current_player.name }}" style="width: 240px; height: 240px; border-radius: 50%; object-fit: cover; border: 4px solid #93c5fd; margin: 0 auto 20px; display: block; box-shadow: 0 8px 32px rgba(147, 197, 253, 0.3);" onerror="this.src='{{ url_for('static', filename='players/default.png') }}'">
        <div id="lv-name" class="metric" style="font-size: 32px;">{{ current_player.name }}</div>
      </div>

      <!-- Right column: Card with two rows + row 3 (eligible teams) -->
      <div class="card" style="padding: 16px; display: flex; flex-direction: column; gap: 16px;">
        <!-- Row 1 -->
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="card">
            <div class="label">Current Bid</div>
            <div id="lv-bid" class="metric" style="color: #10b981;">â‚¹{{ format_currency(auction_state.current_bid) }}</div>
            <div id="lv-leader" style="color: #94a3b8;">{{ auction_state.current_team or "No bids yet" }}</div>
          </div>
          <div class="card">
            <div class="label">Base Price</div>
            <div id="lv-base" class="metric">â‚¹{{ format_currency(current_player.base_price) }}</div>
          </div>
        </div>

        <!-- Row 2 -->
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="card">
            <div class="label">Status</div>
            <div id="lv-status" class="metric" style="font-size: 20px; text-transform: uppercase; color: {% if auction_state.status == 'going' %}#f59e0b{% elif auction_state.status == 'bidding' %}#10b981{% else %}#94a3b8{% endif %};">
              {{ auction_state.status }} <span id="lv-status-emoji">{% if auction_state.status == 'going' %}ðŸ”¥{% elif auction_state.status == 'bidding' %}âš¡{% endif %}</span>
            </div>
          </div>
          {% if starting_team %}
          <div id="lv-starting-wrap" class="card">
            <div class="label">Starting Team</div>
            <div id="lv-starting" class="metric" style="font-size: 20px;">{{ starting_team }}</div>
          </div>
          {% endif %}
        </div>

        <!-- Announcement row (shown when SOLD) -->
        <div id="lv-annc-row" class="card" style="display:none; background:#065f46; color:#e2e8f0; border:1px solid #10b981;"></div>

        <!-- Row 3: Teams who can bid now (hidden when sold) -->
        {% if team_limits and auction_state.status != 'sold' %}
          {% set eligible = team_limits.values()|selectattr('can_bid_now')|list %}
          <div id="lv-eligible-container" class="card" style="padding: 12px;">
            <h3 style="margin: 0 0 8px;">Teams Who Can Bid Now</h3>
            {% if eligible|length == 0 %}
              <div id="lv-eligible-empty" style="color: #94a3b8;">No teams can place the next bid.</div>
            {% else %}
            <div id="lv-eligible-grid" class="grid" style="margin-top: 8px;">
              {% for team, info in team_limits.items() %}
                {% if info.can_bid_now %}
                <div class="card" style="padding: 12px;">
                  <div class="label">{{ team }}</div>
                  <div class="metric" style="color: {{ '#f59e0b' if info.near_limit else '#10b981' }};">
                    â‚¹{{ format_currency(info.max_valid_bid) }}
                  </div>
                  <div style="color: #94a3b8; font-size: 12px;">
                    Remaining: â‚¹{{ format_currency(info.remaining) }} â€¢ Players: {{ info.players_with_captain }}/{{ CONFIG.teams.max_players }}
                  </div>
                  {% if info.near_limit %}
                    <div style="color: #f59e0b; font-size: 12px; margin-top: 4px;">Only one increment possible</div>
                  {% endif %}
                </div>
                {% endif %}
              {% endfor %}
            </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    {% if auction_state.status == "going" %}
    <div class="card" style="background: #7f1d1d; border-color: #dc2626; text-align: center;">
      <h2 style="color: #fca5a5; margin: 0;">GOING ONCE! GOING TWICE!</h2>
      <div style="font-size: 24px; color: white; margin-top: 8px;">
        {{ current_player.name }} - â‚¹{{ format_currency(auction_state.current_bid) }} - {{ auction_state.current_team }}
      </div>
    </div>
    {% endif %}

    

    {% else %}
    <div class="card" style="text-align: center;">
      <h2>No Active Auction</h2>
      <p style="color: #94a3b8;">Waiting for next player...</p>
    </div>
    {% endif %}

  </div>
  <script>
    (function() {
      // Currency formatting mirroring backend
      function formatCurrencyShort(amount) {
        if (amount >= 10000000) {
          const crores = amount / 10000000;
          const s = (Math.round((crores + 1e-9) * 100) / 100).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
          return `${s}Cr`;
        } else if (amount >= 100000) {
          const lakhs = amount / 100000;
          if (Number.isInteger(lakhs)) return `${lakhs}L`;
          return `${lakhs.toFixed(1).replace(/\.0$/, '')}L`;
        }
        return amount.toLocaleString('en-IN');
      }

      let es;
      function connect() {
        try {
          es = new EventSource('{{ url_for('events') }}');
          es.onmessage = function(evt) {
            try {
              const data = JSON.parse(evt.data);
              if (!data) { return; }
              if (data.type !== 'state') { return; }
              if (data.type !== 'state') { return; }
              const s = data.payload || {};
              const root = document.getElementById('lv-root');
              const currentId = root ? root.getAttribute('data-player-id') : '';
              const newId = s.player ? String(s.player.id) : '';
              // If a different non-empty player arrives, reload to rebuild UI
              if ((!currentId && newId) || (currentId && newId && currentId !== newId)) { 
                if (root) root.setAttribute('data-player-id', newId);
                // Update player info and reset auction state for new player
                if (s.player) {
                  const photoEl = document.getElementById('lv-photo');
                  const nameEl = document.getElementById('lv-name');
                  const baseEl = document.getElementById('lv-base');
                  const bidEl = document.getElementById('lv-bid');
                  const leaderEl = document.getElementById('lv-leader');
                  const statusEl = document.getElementById('lv-status');
                  const emojiEl = document.getElementById('lv-status-emoji');
                  
                  if (photoEl) photoEl.src = `/static/players/${s.player.photo || 'default.png'}?t=${Date.now()}`;
                  if (nameEl) nameEl.textContent = s.player.name;
                  if (baseEl) baseEl.textContent = 'â‚¹' + formatCurrencyShort(s.player.base_price);
                  
                  // Reset auction state to new player's initial state
                  const initialBid = s.player.base_price;
                  if (bidEl) bidEl.textContent = 'â‚¹' + formatCurrencyShort(initialBid);
                  if (leaderEl) leaderEl.textContent = 'No bids yet';
                  if (statusEl) {
                    statusEl.textContent = 'BIDDING ';
                    if (emojiEl) {
                      statusEl.appendChild(emojiEl);
                      emojiEl.textContent = 'âš¡';
                    }
                    statusEl.style.color = '#10b981';
                  }
                  // Update starting team for new player
                  const startingWrap = document.getElementById('lv-starting-wrap');
                  const startingEl = document.getElementById('lv-starting');
                  if (startingWrap) {
                    if (s.starting_team) { 
                      startingWrap.style.display = ''; 
                      if (startingEl) startingEl.textContent = s.starting_team; 
                    } else { 
                      startingWrap.style.display = 'none'; 
                    }
                  }
                  
                  // Clear announcement and show eligible teams section
                  const anncRow = document.getElementById('lv-annc-row');
                  const eligibleContainer = document.getElementById('lv-eligible-container');
                  const eligibleGrid = document.getElementById('lv-eligible-grid');
                  const eligibleEmpty = document.getElementById('lv-eligible-empty');
                  if (anncRow) {
                    anncRow.style.display = 'none';
                    anncRow.textContent = '';
                  }
                  if (eligibleContainer) eligibleContainer.style.display = '';
                  
                  // Rebuild eligible teams for new player
                  const elig = Array.isArray(s.eligible) ? s.eligible : [];
                  if (elig.length === 0) {
                    if (eligibleGrid) eligibleGrid.innerHTML = '';
                    if (eligibleEmpty) eligibleEmpty.style.display = '';
                  } else {
                    if (eligibleEmpty) eligibleEmpty.style.display = 'none';
                    if (eligibleGrid) {
                      eligibleGrid.innerHTML = elig.map(item => `
                        <div class="card" style="padding: 12px;">
                          <div class="label">${item.team}</div>
                          <div class="metric" style="color: ${item.near_limit ? '#f59e0b' : '#10b981'};">
                            â‚¹${formatCurrencyShort(item.max_valid_bid || 0)}
                          </div>
                          <div style="color: #94a3b8; font-size: 12px;">
                            Remaining: â‚¹${formatCurrencyShort(item.remaining || 0)} â€¢ Players: ${item.players_with_captain}/{{ CONFIG.teams.max_players }}
                          </div>
                          ${item.near_limit ? '<div style="color: #f59e0b; font-size: 12px; margin-top: 4px;">Only one increment possible</div>' : ''}
                        </div>
                      `).join('');
                    }
                  }
                }
                // Skip the rest of the update for new player to avoid overwriting reset values
                return;
              }

              // Announcement banner
              const anncEl = document.getElementById('lv-annc');
              if (anncEl) {
                if (s.announcement) {
                  anncEl.textContent = s.announcement;
                  anncEl.style.display = '';
                } else {
                  anncEl.style.display = 'none';
                }
              }
              // Patch DOM
              const bidEl = document.getElementById('lv-bid');
              const leaderEl = document.getElementById('lv-leader');
              const statusEl = document.getElementById('lv-status');
              const emojiEl = document.getElementById('lv-status-emoji');
              const startingWrap = document.getElementById('lv-starting-wrap');
              const startingEl = document.getElementById('lv-starting');
              const eligibleGrid = document.getElementById('lv-eligible-grid');
              const eligibleEmpty = document.getElementById('lv-eligible-empty');
              const eligibleContainer = document.getElementById('lv-eligible-container');

              if (bidEl) bidEl.textContent = 'â‚¹' + formatCurrencyShort(s.auction.current_bid || 0);
              if (leaderEl) leaderEl.textContent = s.auction.current_team || 'No bids yet';
              if (statusEl) {
                const st = (s.auction.status || '').toLowerCase();
                statusEl.textContent = (s.auction.status || '').toUpperCase() + ' ';
                if (emojiEl) statusEl.appendChild(emojiEl);
                if (st === 'going') { statusEl.style.color = '#f59e0b'; if (emojiEl) emojiEl.textContent = 'ðŸ”¥'; }
                else if (st === 'bidding') { statusEl.style.color = '#10b981'; if (emojiEl) emojiEl.textContent = 'âš¡'; }
                else if (st === 'sold') { statusEl.style.color = '#10b981'; if (emojiEl) emojiEl.textContent = 'âœ”ï¸'; }
                else { statusEl.style.color = '#94a3b8'; if (emojiEl) emojiEl.textContent = ''; }
              }
              if (startingWrap) {
                if (s.starting_team) { startingWrap.style.display = ''; if (startingEl) startingEl.textContent = s.starting_team; }
                else { startingWrap.style.display = 'none'; }
              }
              // Rebuild eligible teams or show SOLD announcement in row
              const st = (s.auction.status || '').toLowerCase();
              if (st === 'sold') {
                if (eligibleContainer) eligibleContainer.style.display = 'none';
                const anncRow = document.getElementById('lv-annc-row');
                if (anncRow) {
                  if (s.announcement) { anncRow.style.display = ''; anncRow.textContent = s.announcement; }
                  else { anncRow.style.display = 'none'; }
                }
              } else {
                const anncRow = document.getElementById('lv-annc-row');
                if (anncRow) anncRow.style.display = 'none';
                if (eligibleContainer) eligibleContainer.style.display = '';
                const elig = Array.isArray(s.eligible) ? s.eligible : [];
                if (elig.length === 0) {
                  if (eligibleGrid) eligibleGrid.innerHTML = '';
                  if (eligibleEmpty) eligibleEmpty.style.display = '';
                } else {
                  if (eligibleEmpty) eligibleEmpty.style.display = 'none';
                  if (eligibleGrid) {
                    eligibleGrid.innerHTML = elig.map(item => `
                      <div class="card" style="padding: 12px;">
                        <div class="label">${item.team}</div>
                        <div class="metric" style="color: ${item.near_limit ? '#f59e0b' : '#10b981'};">
                          â‚¹${formatCurrencyShort(item.max_valid_bid || 0)}
                        </div>
                        <div style="color: #94a3b8; font-size: 12px;">
                          Remaining: â‚¹${formatCurrencyShort(item.remaining || 0)} â€¢ Players: ${item.players_with_captain}/{{ CONFIG.teams.max_players }}
                        </div>
                        ${item.near_limit ? '<div style="color: #f59e0b; font-size: 12px; margin-top: 4px;">Only one increment possible</div>' : ''}
                      </div>
                    `).join('');
                  }
                }
              }
            } catch (e) {
              console.error('SSE update error:', e);
            }
          };
          es.onerror = function() {
            // Reconnect with backoff
            es && es.close();
            setTimeout(connect, 1000);
          };
        } catch (e) {
          setTimeout(connect, 1500);
        }
      }
      connect();
    })();
  </script>
</body>
</html>
