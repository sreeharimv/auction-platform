<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player Management - {{ CONFIG.tournament.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container" style="max-width: 1400px !important; margin: 20px auto 40px !important; padding: 0 20px !important;">
    <div class="header">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="{{ CONFIG.tournament.name }}" class="logo">
      <h1>{{ CONFIG.tournament.name }}</h1>
    </div>
    <nav style="margin-top: 20px;">
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('players') }}">Players</a>
      <a href="{{ url_for('teams') }}">Teams</a>
      <a href="{{ url_for('results') }}">Live Results</a>
      <a href="{{ url_for('admin') }}">Admin</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <h2>Player Management</h2>

    <!-- CSV Upload Section -->
    <div class="card" style="margin-bottom: 20px;">
      <h3>Upload Player List</h3>
      <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_players') }}">
        <div style="margin-bottom: 16px;">
          <label>Upload CSV File:</label>
          <input type="file" name="csv_file" accept=".csv" required style="margin-left: 12px;">
          <button type="submit" class="btn" style="margin-left: 12px;">Upload & Replace</button>
        </div>
        <div style="font-size: 14px; color: #94a3b8;">
          <strong>Required columns:</strong> name, role, base_price<br>
          <strong>Optional columns:</strong> age, batting_style, bowling_style<br>
          <a href="{{ url_for('download_template') }}" style="color: #93c5fd;">Download CSV Template</a>
        </div>
      </form>
    </div>

    <!-- Add New Player -->
    <div class="card" style="margin-bottom: 20px;">
      <h3>Add New Player</h3>
      <form method="post" action="{{ url_for('add_player') }}">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <input type="text" name="name" placeholder="Player Name" required style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
          <select name="role" required style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
            <option value="">Select Role</option>
            <option value="Batsman">Batsman</option>
            <option value="Bowler">Bowler</option>
            <option value="All-Rounder">All-Rounder</option>
            <option value="Wicket Keeper">Wicket Keeper</option>
          </select>
          <div style="display: flex; gap: 8px;">
            <input type="number" name="base_price_value" placeholder="50" required min="1" step="0.5" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px; width: 80px;">
            <select name="base_price_unit" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
              <option value="lakh" selected>Lakh</option>
              <option value="crore">Crore</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <input type="number" name="age" placeholder="Age (Optional)" min="16" max="50" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
          <select name="batting_style" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
            <option value="">Batting Style (Optional)</option>
            <option value="Right-hand Bat">Right-hand Bat</option>
            <option value="Left-hand Bat">Left-hand Bat</option>
          </select>
          <select name="bowling_style" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 8px; border-radius: 8px;">
            <option value="">Bowling Style (Optional)</option>
            <option value="Right-arm Fast">Right-arm Fast</option>
            <option value="Right-arm Medium">Right-arm Medium</option>
            <option value="Right-arm Off Spin">Right-arm Off Spin</option>
            <option value="Right-arm Leg Spin">Right-arm Leg Spin</option>
            <option value="Left-arm Fast">Left-arm Fast</option>
            <option value="Left-arm Medium">Left-arm Medium</option>
            <option value="Left-arm Spin">Left-arm Spin</option>
          </select>
        </div>
        <button type="submit" class="btn">Add Player</button>
      </form>
    </div>

    <!-- Current Players List -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>Current Players ({{ players|length }})</h3>
        <div>
          <button onclick="resetAllPlayers()" class="btn" style="background: #dc2626; margin-right: 8px;">Reset All</button>
          <a href="{{ url_for('export_players') }}" class="btn secondary">Export CSV</a>
        </div>
      </div>
      
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Photo</th>
              <th>Name</th>
              <th>Role</th>
              <th>Base Price</th>
              <th>Age</th>
              <th>Batting Style</th>
              <th>Bowling Style</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
          {% for player in players %}
            <tr>
              <td>{{ player.player_id }}</td>
              <td>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                  <img src="{{ url_for('static', filename='players/' + (player.photo or 'default.png')) }}?t={{ timestamp() }}" alt="{{ player.name }}" title="Photo: {{ player.photo or 'default.png' }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #374151;" onerror="console.log('Image failed:', this.src); this.src='{{ url_for('static', filename='players/default.png') }}'">
                  <input type="file" id="fileInput_{{ player.player_id }}" accept="image/*" onchange="uploadPhoto({{ player.player_id }}, this)" style="display: none;">
                  <button onclick="document.getElementById('fileInput_{{ player.player_id }}').click()" class="btn" style="background: #059669; font-size: 10px; padding: 2px 6px;" title="Max 5MB, auto-resized to 200x200px">Upload</button>
                </div>
              </td>
              <td>
                <input type="text" value="{{ player.name|dash_if_empty }}" onchange="updatePlayer({{ player.player_id }}, 'name', this.value)" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 4px; border-radius: 4px; width: 120px;">
              </td>
              <td>
                <select onchange="updatePlayer({{ player.player_id }}, 'role', this.value)" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 4px; border-radius: 4px;">
                  <option value="Batsman" {% if player.role == 'Batsman' %}selected{% endif %}>Batsman</option>
                  <option value="Bowler" {% if player.role == 'Bowler' %}selected{% endif %}>Bowler</option>
                  <option value="All-Rounder" {% if player.role == 'All-Rounder' %}selected{% endif %}>All-Rounder</option>
                  <option value="Wicket Keeper" {% if player.role == 'Wicket Keeper' %}selected{% endif %}>Wicket Keeper</option>
                </select>
              </td>
              <td>
                <div style="display: flex; gap: 4px; align-items: center;">
                  <input type="number" value="{{ (player.base_price / 10000000)|int if player.base_price >= 10000000 else (player.base_price / 100000)|int }}" onchange="updatePlayerPrice({{ player.player_id }}, this.value, this.nextElementSibling.value)" min="1" step="0.5" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 2px; border-radius: 4px; width: 60px;">
                  <select onchange="updatePlayerPrice({{ player.player_id }}, this.previousElementSibling.value, this.value)" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 2px; border-radius: 4px; font-size: 11px;">
                    <option value="crore" {% if player.base_price >= 10000000 %}selected{% endif %}>Cr</option>
                    <option value="lakh" {% if player.base_price < 10000000 %}selected{% endif %}>L</option>
                  </select>
                </div>
              </td>
              <td>
                <input type="number" value="{{ player.age|int if player.age and player.age != '' and player.age != 'nan' else '' }}" onchange="updatePlayer({{ player.player_id }}, 'age', this.value)" min="16" max="50" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 2px; border-radius: 4px; width: 50px;" placeholder="-">
              </td>
              <td>
                <select onchange="updatePlayer({{ player.player_id }}, 'batting_style', this.value)" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 2px; border-radius: 4px; font-size: 11px;">
                  <option value="">-</option>
                  <option value="Right-hand Bat" {% if player.batting_style == 'Right-hand Bat' %}selected{% endif %}>Right-hand Bat</option>
                  <option value="Left-hand Bat" {% if player.batting_style == 'Left-hand Bat' %}selected{% endif %}>Left-hand Bat</option>
                </select>
              </td>
              <td>
                <select onchange="updatePlayer({{ player.player_id }}, 'bowling_style', this.value)" style="background: #0b1220; border: 1px solid #334155; color: #e2e8f0; padding: 2px; border-radius: 4px; font-size: 11px;">
                  <option value="">-</option>
                  <option value="Right-arm Fast" {% if player.bowling_style == 'Right-arm Fast' %}selected{% endif %}>Right-arm Fast</option>
                  <option value="Right-arm Medium" {% if player.bowling_style == 'Right-arm Medium' %}selected{% endif %}>Right-arm Medium</option>
                  <option value="Right-arm Off Spin" {% if player.bowling_style == 'Right-arm Off Spin' %}selected{% endif %}>Right-arm Off Spin</option>
                  <option value="Right-arm Leg Spin" {% if player.bowling_style == 'Right-arm Leg Spin' %}selected{% endif %}>Right-arm Leg Spin</option>
                  <option value="Left-arm Fast" {% if player.bowling_style == 'Left-arm Fast' %}selected{% endif %}>Left-arm Fast</option>
                  <option value="Left-arm Medium" {% if player.bowling_style == 'Left-arm Medium' %}selected{% endif %}>Left-arm Medium</option>
                  <option value="Left-arm Spin" {% if player.bowling_style == 'Left-arm Spin' %}selected{% endif %}>Left-arm Spin</option>
                </select>
              </td>
              <td>
                <span style="color: {% if player.status == 'captain' %}#f59e0b{% elif player.status == 'sold' %}#10b981{% else %}#94a3b8{% endif %};">
                  {{ player.status|title }}
                </span>
              </td>
              <td>
                <button onclick="deletePlayer({{ player.player_id }})" class="btn" style="background: #dc2626; font-size: 12px; padding: 4px 8px;">Delete</button>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    function updatePlayer(playerId, field, value) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/update-player';
      form.innerHTML = `
        <input type="hidden" name="player_id" value="${playerId}">
        <input type="hidden" name="field" value="${field}">
        <input type="hidden" name="value" value="${value}">
      `;
      document.body.appendChild(form);
      form.submit();
    }

    function deletePlayer(playerId) {
      if (confirm('Delete this player? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete-player';
        form.innerHTML = `<input type="hidden" name="player_id" value="${playerId}">`;
        document.body.appendChild(form);
        form.submit();
      }
    }

    function updatePlayerPrice(playerId, value, unit) {
      const actualPrice = unit === 'crore' ? value * 10000000 : value * 100000;
      updatePlayer(playerId, 'base_price', actualPrice);
    }
    
    function uploadPhoto(playerId, input) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Client-side validation
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
          showError('File too large! Maximum size is 5MB. Your file is ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
          input.value = ''; // Clear the input
          return;
        }
        
        // Check if it's an image
        if (!file.type.startsWith('image/')) {
          showError('Please select an image file (JPEG, PNG, GIF, etc.)');
          input.value = '';
          return;
        }
        
        // Show loading indicator
        const uploadBtn = input.parentElement.querySelector('button');
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = 'â³';
        uploadBtn.disabled = true;
        
        const formData = new FormData();
        formData.append('photo', file);
        formData.append('player_id', playerId);
        
        fetch('/upload-player-photo', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccess('Photo uploaded successfully!');
            setTimeout(() => location.reload(), 1000);
          } else {
            showError('Upload failed: ' + data.error);
            uploadBtn.textContent = originalText;
            uploadBtn.disabled = false;
          }
        })
        .catch(error => {
          showError('Network error. Please check your connection and try again.');
          uploadBtn.textContent = originalText;
          uploadBtn.disabled = false;
        });
      }
    }
    
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'flash error';
      errorDiv.textContent = message;
      errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 500px;';
      document.body.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }
    
    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'flash success';
      successDiv.textContent = message;
      successDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 500px;';
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 3000);
    }
    
    function resetAllPlayers() {
      if (confirm('Reset all players to unsold status? This will clear all auction data!')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/reset-all-players';
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
</body>
</html>